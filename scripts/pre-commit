#!/bin/bash

# Pre-commit hook for Jellyfin Plugin TorrentDownloader
# Validates version consistency between project file and manifest.json

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Paths relative to git root
GIT_ROOT=$(git rev-parse --show-toplevel)
CSPROJ_FILE="$GIT_ROOT/Jellyfin.Plugin.TorrentDownloader/Jellyfin.Plugin.TorrentDownloader.csproj"
MANIFEST_FILE="$GIT_ROOT/manifest.json"

# Check if files exist
if [[ ! -f "$CSPROJ_FILE" ]]; then
    echo -e "${RED}Error: Project file not found: $CSPROJ_FILE${NC}" >&2
    exit 1
fi

if [[ ! -f "$MANIFEST_FILE" ]]; then
    echo -e "${RED}Error: Manifest file not found: $MANIFEST_FILE${NC}" >&2
    exit 1
fi

# Check for required tools
if ! command -v jq >/dev/null 2>&1; then
    echo -e "${YELLOW}Warning: jq not installed, skipping version validation${NC}" >&2
    echo -e "${YELLOW}Install jq with: brew install jq${NC}" >&2
    exit 0
fi

# Extract versions
CSPROJ_VERSION=$(grep -o '<Version>[^<]*</Version>' "$CSPROJ_FILE" | sed 's/<Version>\(.*\)<\/Version>/\1/')
MANIFEST_VERSION=$(jq -r '.version' "$MANIFEST_FILE")
MANIFEST_VERSIONS_ARRAY=$(jq -r '.versions[].version' "$MANIFEST_FILE")

# Check if versions could be extracted
if [[ -z "$CSPROJ_VERSION" ]]; then
    echo -e "${RED}Error: Could not extract version from project file${NC}" >&2
    exit 1
fi

if [[ -z "$MANIFEST_VERSION" ]]; then
    echo -e "${RED}Error: Could not extract version from manifest.json${NC}" >&2
    exit 1
fi

# Validate all versions match
VERSION_MISMATCH=false

if [[ "$CSPROJ_VERSION" != "$MANIFEST_VERSION" ]]; then
    VERSION_MISMATCH=true
    echo -e "${RED}✗ Version mismatch detected!${NC}" >&2
    echo -e "${RED}  Project file:  $CSPROJ_VERSION${NC}" >&2
    echo -e "${RED}  Manifest root: $MANIFEST_VERSION${NC}" >&2
fi

# Check all versions array entries
while IFS= read -r array_version; do
    if [[ "$array_version" != "$CSPROJ_VERSION" ]]; then
        VERSION_MISMATCH=true
        echo -e "${RED}✗ Version mismatch in manifest versions array!${NC}" >&2
        echo -e "${RED}  Project file:       $CSPROJ_VERSION${NC}" >&2
        echo -e "${RED}  Manifest version[]: $array_version${NC}" >&2
    fi
done <<< "$MANIFEST_VERSIONS_ARRAY"

if [[ "$VERSION_MISMATCH" == true ]]; then
    echo "" >&2
    echo -e "${YELLOW}Version numbers must be synchronized across all files.${NC}" >&2
    echo -e "${YELLOW}Fix this by running:${NC}" >&2
    echo -e "${YELLOW}  ./scripts/bump-version.sh $CSPROJ_VERSION${NC}" >&2
    echo "" >&2
    echo -e "${YELLOW}Or to bypass this check (not recommended):${NC}" >&2
    echo -e "${YELLOW}  git commit --no-verify${NC}" >&2
    exit 1
fi

# All versions match
echo -e "${GREEN}✓ Version consistency validated ($CSPROJ_VERSION)${NC}"
exit 0
